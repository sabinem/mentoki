#encoding: utf-8

"""
Transactions are stored here. They correspond to braintree transactions.
"""

from django.db import models
from django.utils.translation import ugettext_lazy as _

from .customer import Customer
from apps_data.course.models.course import Course
from apps_customerdata.customer.models.order import Order
from apps_customerdata.customer.models.temporder import TempOrder
from apps_productdata.mentoki_product.constants import CURRENCY_CHOICES


class TransactionManager(models.Manager):
    """
    handles Transactions with the payment provider braintree
    """
    def create(self, amount, currency,
               customer, order,
               braintree_merchant_account_id,
               braintree_transaction_id):
        """
        the transaction is create right when the customer has the intention to pay
        it is then updated during the payment process
        """
        transaction = SuccessfulTransaction(
            amount=amount,
            currency=currency,
            order=order,
            course=order.course,
            customer=customer,
            braintree_merchant_account_id=braintree_merchant_account_id,
            braintree_transaction_id=braintree_transaction_id)
        transaction.save()
        return transaction


class Transaction(models.Model):
    """
    Transactions are stored in this model. A flag indicates whether
    they passed successfully.
    """

    # order must be present
    order = models.ForeignKey(Order)

    # will be an index later on
    course = models.ForeignKey(Course, blank=True, null=True)

    # customer that performed the transaction; is empty for newusers initially
    customer = models.ForeignKey(Customer, blank=True, null=True)

    # braintree transaction data and the merchant key that was used
    braintree_transaction_id = models.CharField(
        max_length=50,
        blank=True)
    braintree_merchant_account_id = models.CharField(
        'braintree_merchant',
        max_length=100,
        blank=True)
    braintree_customer_id = models.CharField(
        'braintree Kundennr.',
        max_length=100,
        blank=True)

    # amount and currency of the transaction
    amount = models.DecimalField(
        _("amount"),
        decimal_places=4,
        max_digits=20)
    currency = models.CharField(max_length=3, choices=CURRENCY_CHOICES,
        default=CURRENCY_CHOICES.euro )

    # time when the tranaction was created
    created = models.DateTimeField(auto_now_add=True)

    # flag, whether the transaction had success
    flag_sucess = models.BooleanField(default=False)

    class Meta:
        abstract = True
        verbose_name = 'Transaktion'
        verbose_name_plural = 'Transaktionen'

    def __unicode__(self):
        #TODO: determine later on
        return "%s: %s" % (self.order, self.id)

    def __repr__(self):
        #TODO: determine later on
        return "%s: %s" % (self.order, self.id)


#TODO: what follows may all be deleted later on!
class BaseTransaction(models.Model):
    """
    This is an abstract class that defines a structure of Payment model that will be
    generated dynamically with one additional field: ``order``
    """
    # what mentoki wanted
    amount = models.DecimalField(
        _("amount"),
        decimal_places=4,
        max_digits=20)
    currency = models.CharField(max_length=3, choices=CURRENCY_CHOICES,
        default=CURRENCY_CHOICES.euro )
    course = models.ForeignKey(Course, blank=True, null=True)
    customer = models.ForeignKey(Customer)
    # what braintree got
    braintree_transaction_id = models.CharField(
        max_length=50,
        primary_key=True,
        default="x")
    braintree_merchant_account_id = models.CharField(
        'braintree_merchant',
        max_length=100,
        default="default")
    created = models.DateTimeField(auto_now_add=True)

    class Meta:
        abstract = True
        verbose_name = 'Transaktion'
        verbose_name_plural = 'Transaktionen'

    def __unicode__(self):
        return self.braintree_transaction_id


class TransactionManager(models.Manager):
    def create(self, amount, currency,
               customer, order,
               braintree_merchant_account_id,
               braintree_transaction_id):
        transaction = SuccessfulTransaction(
            amount=amount,
            currency=currency,
            order=order,
            course=order.course,
            customer=customer,
            braintree_merchant_account_id=braintree_merchant_account_id,
            braintree_transaction_id=braintree_transaction_id)
        transaction.save()
        return transaction


class SuccessfulTransaction(BaseTransaction):
    """
    This is an abstract class that defines a structure of Payment model that will be
    generated dynamically with one additional field: ``order``
    """
    order = models.ForeignKey(
        Order
    )
    objects = TransactionManager()

    class Meta:
        verbose_name = 'Erfolgreiche Transaktion'
        verbose_name_plural = 'Erfolgreiche Transaktionen'

    def __unicode__(self):
        return self.braintree_transaction_id


class FailedTransactionManager(models.Manager):
    def create(self, amount, currency,
               customer, temporder,
               braintree_merchant_account_id,
               braintree_transaction_id):
        transaction = BaseTransaction(
            amount=amount,
            currency=currency,
            temporder = temporder,
            customer=customer,
            braintree_merchant_account_id=braintree_merchant_account_id,
            braintree_transaction_id=braintree_transaction_id)
        transaction.save()
        return transaction


class FailedTransaction(BaseTransaction):
    """
    This is an abstract class that defines a structure of Payment model that will be
    generated dynamically with one additional field: ``order``
    """
    # what mentoki wanted
    temporder = models.ForeignKey(
        TempOrder
    )
    braintree_result = models.TextField(blank=True)

    objects = FailedTransactionManager()

    class Meta:
        verbose_name = 'Nicht erfolgreiche Transaktion'
        verbose_name_plural = 'Nicht erfolgreiche Transaktionen'

    def __unicode__(self):
        return self.braintree_transaction_id